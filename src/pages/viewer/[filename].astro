---
import PageLayout from '../../layouts/PageLayout.astro';
import { Icon } from 'astro-icon/components';

// Define the PDF files that can be viewed
export async function getStaticPaths() {
  return [
    { params: { filename: 'MEDICAL MINDSCAPE 1.pdf' } },
    { params: { filename: 'NUMSA Journal (3)_compressed_250420_022657.pdf' } },
    { params: { filename: 'NUMSA MAGAZINE 2 (1)_compressed_250420_022813.pdf' } }
  ];
}

const file = Astro.params.filename;
const fileName = file ? decodeURIComponent(file) : '';

const metadata = {
  title: `Viewing ${fileName}`,
  description: `PDF Viewer for ${fileName}`,
};
---

<PageLayout metadata={metadata}>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
      <div class="container mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <a href="/publications" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white transition-colors">
              <Icon name="tabler:chevron-left" class="w-5 h-5" />
              <span class="font-medium">Back to Publications</span>
            </a>
          </div>
          <div class="flex items-center gap-4">
            <h1 class="text-lg font-semibold text-gray-900 dark:text-white truncate max-w-md">
              {fileName}
            </h1>
            <div class="flex gap-2">
              <button 
                id="fullscreen-btn"
                class="px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors flex items-center gap-2"
                title="Toggle Fullscreen"
              >
                <Icon name="tabler:maximize" class="w-4 h-4" />
              </button>
              <a 
                href={`/documents/publications/${fileName}`}
                class="px-4 py-2 bg-blue-600 dark:bg-blue-500 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors flex items-center gap-2"
                download
              >
                <Icon name="tabler:download" class="w-4 h-4" />
                Download
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- PDF Viewer -->
    <main class="container mx-auto px-4 py-6">
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden">
        <!-- PDF Controls -->
        <!-- <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 border-b border-gray-200 dark:border-gray-600">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <button 
                id="prev-page"
                class="px-3 py-2 bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                <Icon name="tabler:chevron-left" class="w-4 h-4" />
                Previous
              </button>
              <span id="page-info" class="text-sm text-gray-600 dark:text-gray-400">
                Page <span id="current-page">1</span> of <span id="total-pages">-</span>
              </span>
              <button 
                id="next-page"
                class="px-3 py-2 bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                disabled
              >
                Next
                <Icon name="tabler:chevron-right" class="w-4 h-4" />
              </button>
            </div>
            <div class="flex items-center gap-2">
              <button 
                id="zoom-out"
                class="px-3 py-2 bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors"
                title="Zoom Out"
              >
                <Icon name="tabler:minus" class="w-4 h-4" />
              </button>
              <span id="zoom-level" class="text-sm text-gray-600 dark:text-gray-400 px-2">100%</span>
              <button 
                id="zoom-in"
                class="px-3 py-2 bg-white dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-500 transition-colors"
                title="Zoom In"
              >
                <Icon name="tabler:plus" class="w-4 h-4" />
              </button>
            </div>
          </div>
        </div> -->

        <div id="pdf-viewer" class="w-full h-[calc(100vh-280px)] min-h-[600px] relative">
          {fileName ? (
            <div class="relative w-full h-full">
              <iframe 
                src={`/documents/publications/${fileName}#toolbar=1&navpanes=1&scrollbar=1&view=FitH&pagemode=thumbs`}
                class="w-full h-full border-0"
                title="PDF Viewer"
                id="pdf-iframe"
                allowfullscreen
              />
              <noscript>
                <div class="p-4 text-center text-gray-600 dark:text-gray-300">
                  Your browser does not support iframes. 
                  <a href={`/documents/publications/${fileName}`} target="_blank" class="text-blue-600 dark:text-blue-400 hover:underline">
                    Click here to open the PDF in a new tab
                  </a>
                </div>
              </noscript>
              
              <!-- Loading overlay -->
              <div id="loading-overlay" class="absolute inset-0 bg-white dark:bg-gray-800 bg-opacity-95 flex items-center justify-center backdrop-blur-sm transition-opacity duration-300">
                <div class="text-center max-w-md mx-auto p-8">
                  <!-- Modern loading spinner -->
                  <div class="relative mb-6">
                    <div class="w-16 h-16 border-4 border-blue-200 dark:border-gray-600 rounded-full animate-spin mx-auto">
                      <div class="absolute top-0 left-0 w-16 h-16 border-4 border-transparent border-t-blue-600 dark:border-t-blue-400 rounded-full animate-spin"></div>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <Icon name="tabler:file-text" class="w-6 h-6 text-blue-600 dark:text-blue-400" />
                    </div>
                  </div>
                  
                  <!-- Loading text with animation -->
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2 animate-pulse">
                    Loading PDF Viewer
                  </h3>
                  <p class="text-gray-600 dark:text-gray-300 mb-4">
                    Preparing {fileName} for viewing...
                  </p>
                  <div class="text-xs text-gray-500 dark:text-gray-400 mb-4">
                    <span id="file-info">Loading file information...</span>
                  </div>
                  
                  <!-- Progress bar -->
                  <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-4">
                    <div id="progress-bar" class="bg-gradient-to-r from-blue-500 to-blue-600 h-2 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                  </div>
                  
                  <!-- Loading steps -->
                  <div class="space-y-2 text-sm text-gray-500 dark:text-gray-400">
                    <div id="step-1" class="flex items-center gap-2">
                      <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                      <span>Initializing viewer...</span>
                    </div>
                    <div id="step-2" class="flex items-center gap-2 opacity-50">
                      <div class="w-2 h-2 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                      <span>Loading PDF content...</span>
                    </div>
                    <div id="step-3" class="flex items-center gap-2 opacity-50">
                      <div class="w-2 h-2 bg-gray-300 dark:bg-gray-600 rounded-full"></div>
                      <span>Rendering pages...</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Error overlay -->
              <div id="error-overlay" class="hidden absolute inset-0 bg-white dark:bg-gray-800 bg-opacity-90 flex items-center justify-center">
                <div class="text-center">
                  <Icon name="tabler:alert-circle" class="w-16 h-16 text-red-500 mx-auto mb-4" />
                  <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">PDF Not Available</h2>
                  <p class="text-gray-600 dark:text-gray-300 mb-4">The PDF file could not be loaded. It may not be available yet.</p>
                  <div class="flex gap-3 justify-center">
                    <a 
                      href={`/documents/publications/${fileName}`}
                      target="_blank"
                      class="px-6 py-3 bg-blue-600 dark:bg-blue-500 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors inline-flex items-center gap-2"
                    >
                      <Icon name="tabler:external-link" class="w-4 h-4" />
                      Open in New Tab
                    </a>
                    <a 
                      href={`/documents/publications/${fileName}`}
                      class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors inline-flex items-center gap-2"
                      download
                    >
                      <Icon name="tabler:download" class="w-4 h-4" />
                      Download
                    </a>
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <div class="flex items-center justify-center h-full">
              <div class="text-center">
                <Icon name="tabler:file-text" class="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No PDF Selected</h2>
                <p class="text-gray-600 dark:text-gray-300 mb-4">Please select a PDF file to view</p>
                <a href="/publications" class="px-6 py-3 bg-blue-600 dark:bg-blue-500 text-white rounded-lg hover:bg-blue-700 dark:hover:bg-blue-600 transition-colors">
                  Go to Publications
                </a>
              </div>
            </div>
          )}
        </div>
      </div>
    </main>
  </div>
</PageLayout>

<script>
  if (typeof window !== 'undefined') {
    const iframe = document.getElementById('pdf-iframe');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorOverlay = document.getElementById('error-overlay');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const currentPageSpan = document.getElementById('current-page');
    const totalPagesSpan = document.getElementById('total-pages');
    const zoomInBtn = document.getElementById('zoom-in');
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomLevelSpan = document.getElementById('zoom-level');
    
    let currentPage = 1;
    let totalPages = 0;
    let currentZoom = 100;
    
    if (iframe) {
      const progressBar = document.getElementById('progress-bar');
      const step1 = document.getElementById('step-1');
      const step2 = document.getElementById('step-2');
      const step3 = document.getElementById('step-3');
      const fileInfo = document.getElementById('file-info');
      
      // Simulate file size and load time
      const fileSizes = {
        'MEDICAL MINDSCAPE 1.pdf': '2.4 MB',
        'NUMSA Journal (3)_compressed_250420_022657.pdf': '1.8 MB',
        'NUMSA MAGAZINE 2 (1)_compressed_250420_022813.pdf': '3.1 MB'
      };
      
      // Get filename from URL path
      const pathSegments = window.location.pathname.split('/');
      const currentFileName = decodeURIComponent(pathSegments[pathSegments.length - 1]);
      
      const estimatedTime = Math.floor(Math.random() * 3) + 2; // 2-4 seconds
      const fileSize = fileSizes[currentFileName] || 'Unknown size';
      
      if (fileInfo) {
        fileInfo.textContent = `${fileSize} • Estimated load time: ${estimatedTime}s`;
        
        // Update loading time in real-time
        let elapsedTime = 0;
        const timeInterval = setInterval(() => {
          elapsedTime++;
          if (fileInfo) {
            fileInfo.textContent = `${fileSize} • Loading... ${elapsedTime}s`;
          }
        }, 1000);
        
        // Clear time interval when loading completes
        iframe.addEventListener('load', () => {
          clearInterval(timeInterval);
          if (fileInfo) {
            fileInfo.textContent = `${fileSize} • Loaded successfully!`;
          }
        });
      }
      
      // Progressive loading simulation
      let progress = 0;
      const progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        
        if (progressBar) {
          progressBar.style.width = `${progress}%`;
        }
        
        // Update steps
        if (progress > 30 && step2) {
          step2.classList.remove('opacity-50');
          step2.querySelector('div').classList.add('bg-blue-500', 'animate-pulse');
        }
        if (progress > 60 && step3) {
          step3.classList.remove('opacity-50');
          step3.querySelector('div').classList.add('bg-blue-500', 'animate-pulse');
        }
      }, 200);
      
      // Hide loading overlay when iframe loads
      iframe.addEventListener('load', () => {
        console.log('PDF loaded successfully');
        clearInterval(progressInterval);
        
        if (progressBar) {
          progressBar.style.width = '100%';
        }
        
        // Final step completion
        if (step3) {
          step3.querySelector('div').classList.remove('animate-pulse');
          step3.querySelector('div').classList.add('bg-green-500');
        }
        
        // Hide overlay with delay for smooth transition
        setTimeout(() => {
          if (loadingOverlay) {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
              loadingOverlay.style.display = 'none';
            }, 300);
          }
        }, 500);
      });
      
      // Show error overlay if PDF fails to load
      iframe.addEventListener('error', () => {
        clearInterval(progressInterval);
        if (loadingOverlay) loadingOverlay.style.display = 'none';
        if (errorOverlay) errorOverlay.classList.remove('hidden');
      });
    }
    // Fullscreen logic
    if (fullscreenBtn && iframe) {
      fullscreenBtn.addEventListener('click', () => {
        if (iframe.requestFullscreen) {
          iframe.requestFullscreen();
        } else if ((iframe as any).webkitRequestFullscreen) {
          (iframe as any).webkitRequestFullscreen();
        }
      });
    }
    // Keyboard navigation, zoom, etc. can be added here
  }
</script>